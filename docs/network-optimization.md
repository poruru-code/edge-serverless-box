# 技術決定事項: ネットワーク最適化（IP 直接指定による堅牢化）

## 背景
Docker コンテナ間の通信において、通常はコンテナ名（ホスト名）を用いた名前解決（DNS）が利用されます。しかし、本プロジェクトがシミュレートする「Lambda の冷間起動（Cold Start）」という文脈においては、DNS への依存が以下の課題を引き起こします。

1. **DNS 伝播のタイムラグ**: コンテナが `running` 状態になっても、Docker の内部 DNS に名前が登録され、リゾルバ経由で引けるようになるまでには数百 ms 〜 数秒の遅延が発生することがあります。
2. **解決プロセスのオーバーヘッド**: 安定動作時であっても、OS のリゾルバを経由するプロセス自体に無視できないコストがかかります。

## 解決策
`ContainerManager` が Lambda コンテナを管理する際、コンテナ名による解決を避け、Docker API から直接取得した **IP アドレス** を通信に使用します。

## 根拠と検証データ

### 1. 定量性能
`onpre-manager` コンテナ内から同一ネットワーク上のコンテナへの接続速度を計測した結果、IP 直接指定の圧倒的な優位性が確認されました。

| 解決方法 | 平均レイテンシ | 比較 |
| :--- | :--- | :--- |
| **ホスト名 (DNS経由)** | **0.595 ms** | - |
| **IPアドレス (直接指定)** | **0.092 ms** | **約 6.5 倍高速** |

※ 物理的な接続時間そのものよりも、名前解決のオーケストレーションにかかるコストが高いことを示しています。

### 2. Cold Start 高速化への寄与
DNS 伝播を待つ必要がないため、Docker エンジンがコンテナに IP を割り当てた瞬間に疎通確認（Readiness Check）を開始できます。これにより、開発者が体感する Cold Start の待ち時間を理論上の最速値まで短縮しています。

### 3. 基盤依存の排除
Docker の内部 DNS サービスの状態に左右されず、Manager Service が持つ「どのコンテナにどの IP が割り当てられたか」という確実な情報をソースとすることで、システムの決定論的な動作（Determinism）を確保しています。

## 実装の詳細
`services/manager/service.py` における `ensure_container_running` の実装では、コンテナの `start`/`run` 直後に `container.reload()` を呼び出し、最新の `NetworkSettings` から IP を抜き出すロジックを採用しています。

もし何らかの理由で IP が取得できない等の例外的なケースに備え、最終的なフォールバックとしてコンテナ名（ホスト名）を使用する多重の堅牢性（Layered Resilience）を備えています。
