# Firecracker mode overrides (Phase C experimentation).
# Usage:
#   COMPOSE_FILE=docker-compose.yml:docker-compose.fc.yml docker compose up -d
#
# Note:
# - runtime-node は firecracker-containerd を起動する想定。
# - firecracker runtime/shim と設定は runtime-node イメージに含める。

services:
  runtime-node:
    networks:
      runtime_net:
        ipv4_address: ${RUNTIME_NODE_IP:-172.20.0.10}
    environment:
      - CONTAINERD_BIN=/usr/local/bin/firecracker-containerd
      - CONTAINERD_CONFIG=/etc/firecracker-containerd/config.toml
      - DEVMAPPER_POOL=fc-dev-pool2
      - DEVMAPPER_DIR=/var/lib/containerd/devmapper2
      - DEVMAPPER_DATA_SIZE=10G
      - DEVMAPPER_META_SIZE=2G
      - DEVMAPPER_UDEV=1
      - VHOST_VSOCK_REQUIRED=${VHOST_VSOCK_REQUIRED:-1}
      - WG_CONTROL_NET=${WG_CONTROL_NET:-10.99.0.0/24}
    volumes:
      - /dev:/dev
  agent:
    environment:
      - AGENT_RUNTIME=containerd
      - CONTAINERD_RUNTIME=aws.firecracker
  gateway:
    environment:
      - GATEWAY_INTERNAL_URL=${GATEWAY_INTERNAL_URL:-https://10.99.0.1:443}

networks:
  runtime_net:
    driver: bridge
    ipam:
      config:
        - subnet: ${RUNTIME_NET_SUBNET:-172.20.0.0/16}
