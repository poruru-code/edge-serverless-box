# Where: docker-compose.node.yml
# What: Compute-plane services for Firecracker/containerd nodes.
# Why: Run runtime-node/agent/local-proxy on dedicated compute hosts.

services:
  # ============================================
  # Runtime Node (firecracker-containerd + DNAT)
  # ============================================
  runtime-node:
    image: ${CONTAINER_REGISTRY:-esb-registry:5010}/esb-runtime-node:latest
    container_name: esb-runtime-node
    privileged: true
    ports:
      - "50051:50051"
    volumes:
      - runtime_containerd_run:/run/containerd
      - runtime_containerd_lib:/var/lib/containerd
      - esb_cni_data:/var/lib/cni
      - ${ESB_CERT_DIR:-~/.esb/certs}/rootCA.crt:/usr/local/share/ca-certificates/esb-rootCA.crt:ro
      - /dev:/dev
    environment:
      - CNI_GW_IP=10.88.0.1
      - DNAT_S3_IP=127.0.0.1
      - DNAT_DB_IP=127.0.0.1
      - DNAT_VL_IP=127.0.0.1
      - DNAT_DB_PORT=8001
      - CONTAINERD_BIN=/usr/local/bin/firecracker-containerd
      - CONTAINERD_CONFIG=/etc/firecracker-containerd/config.toml
      - DEVMAPPER_POOL=fc-dev-pool2
      - DEVMAPPER_DIR=/var/lib/containerd/devmapper2
      - DEVMAPPER_DATA_SIZE=10G
      - DEVMAPPER_META_SIZE=2G
      - DEVMAPPER_UDEV=0
      - VHOST_VSOCK_REQUIRED=${VHOST_VSOCK_REQUIRED:-1}
      - WG_CONTROL_NET=${WG_CONTROL_NET:-10.99.0.0/24}
      - WG_CONTROL_GW=${WG_CONTROL_GW:-}
      - WG_CONTROL_GW_HOST=${WG_CONTROL_GW_HOST:-gateway}
      - DNAT_APPLY_OUTPUT=1
    healthcheck:
      test: ["CMD", "ctr", "-a", "/run/containerd/containerd.sock", "version"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    extra_hosts:
      - "esb-registry:${ESB_CONTROL_HOST:-127.0.0.1}"
      - "s3-storage:${ESB_CONTROL_HOST:-127.0.0.1}"
      - "database:${ESB_CONTROL_HOST:-127.0.0.1}"
      - "victorialogs:${ESB_CONTROL_HOST:-127.0.0.1}"
      - "gateway:${ESB_CONTROL_HOST:-127.0.0.1}"
    networks:
      runtime_net:
        ipv4_address: ${RUNTIME_NODE_IP:-172.20.0.10}

  # ============================================
  # Local Proxy (HAProxy for DNAT targets)
  # ============================================
  local-proxy:
    image: haproxy:2.8-alpine
    container_name: esb-local-proxy
    network_mode: "service:runtime-node"
    volumes:
      - ./config/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      runtime-node:
        condition: service_started
    restart: unless-stopped

  # ============================================
  # Go Agent (Replacement for Orchestrator)
  # ============================================
  agent:
    image: ${CONTAINER_REGISTRY:-esb-registry:5010}/esb-agent:latest
    container_name: esb-agent
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    pid: "container:esb-runtime-node"
    # runtime-node NetNS: Agent listens on :50051
    network_mode: "service:runtime-node"
    volumes:
      - runtime_containerd_run:/run/containerd  # Required for socket, fifo, and shim access
      - runtime_containerd_lib:/var/lib/containerd  # Required for snapshot access
      - ./services/agent/config/cni:/etc/cni/net.d:ro
      - esb_cni_data:/var/lib/cni
      - ${ESB_CERT_DIR:-~/.esb/certs}/rootCA.crt:/usr/local/share/ca-certificates/esb-rootCA.crt:ro
    environment:
      - AGENT_RUNTIME=containerd  # Use containerd with runtime-node netns strategy
      - CONTAINERD_RUNTIME=aws.firecracker
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PORT=50051
      - CONTAINER_REGISTRY=${CONTAINER_REGISTRY:-esb-registry:5010}
      - CNI_SUBNET=${CNI_SUBNET:-}
    depends_on:
      runtime-node:
        condition: service_healthy
    command: >
      sh -c "update-ca-certificates && /app/agent"
    restart: unless-stopped

volumes:
  runtime_containerd_run:
  runtime_containerd_lib:
  esb_cni_data:

networks:
  runtime_net:
    driver: bridge
    ipam:
      config:
        - subnet: ${RUNTIME_NET_SUBNET:-172.20.0.0/16}
